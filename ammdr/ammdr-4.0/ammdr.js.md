# Документация AMMDr JavaScript (версия 4.0)

## Обзор

AMMDr (aMagic Markdown Reader) - это JavaScript-класс для управления интерфейсом просмотра Markdown-документов. Класс предоставляет функционал для работы с древовидным меню, поиска документов и управления состоянием приложения.

## Класс AMMDrUI

### Конструктор

```javascript
constructor()
```
Инициализирует экземпляр AMMDrUI, устанавливает начальные значения и привязывает обработчики событий.

**Инициализирует:**
- Текущий поисковый запрос (`currentSearchQuery`)
- Текущий вид меню (`currentView`, по умолчанию 'tree')
- DOM-элементы
- Обработчики событий
- Состояние приложения
- Обработчики для папок

### Основные методы

#### `initElements()`
Инициализирует и кэширует все необходимые DOM-элементы.

**Элементы:**
- `$body` - тело документа
- `$mainNav` - основная навигация
- `$menuContainer` - контейнер меню
- `$search` - поле поиска
- `$contentWrapper` - контейнер контента
- `$loading` - индикатор загрузки
- `$mobileMenuBtn` - кнопка мобильного меню
- `$menuBtn` - кнопка меню
- `$navBtns` - кнопки переключения вида
- `$scanBtn` - кнопка сканирования

#### `bindEvents()`
Привязывает обработчики событий ко всем интерактивным элементам.

**Обрабатываемые события:**
- Клики по файлам в меню
- Клики по кнопкам переключения вида
- Клик по кнопке сканирования
- Ввод в поле поиска
- Клики по кнопкам мобильного меню
- Изменения истории браузера (навигация назад/вперед)

#### `initState()`
Инициализирует начальное состояние приложения:
- Активирует текущий вид меню
- Восстанавливает состояние папок и активный файл из URL

#### `reloadMenu(html)`
Обновляет меню и перепривязывает обработчики.

**Параметры:**
- `html` - HTML-код нового меню

**Функционал:**
- Заменяет содержимое контейнера меню
- Перепривязывает обработчики папок
- Восстанавливает активный файл

### Обработчики действий

#### `handleFileClick(e)`
Обрабатывает клик по файлу в меню.

**Логика:**
1. Предотвращает действие по умолчанию
2. Показывает индикатор загрузки
3. Загружает Markdown-файл
4. Обновляет URL
5. Устанавливает активный файл
6. Скрывает мобильное меню (если нужно)
7. Скрывает индикатор загрузки

#### `handleViewChange(e)`
Обрабатывает переключение вида меню.

**Логика:**
1. Обновляет текущий вид
2. Переключает активную кнопку
3. Обновляет меню

#### `handleScan()`
Обрабатывает сканирование директории.

**Логика:**
1. Показывает индикатор загрузки
2. Отправляет AJAX-запрос на сканирование
3. Обновляет меню после получения ответа
4. Обрабатывает ошибки

#### `handleSearchInput()`
Обрабатывает ввод в поле поиска.

**Логика:**
1. Очищает предыдущий таймер
2. Обновляет текущий запрос
3. При длине запроса ≥2 символов - обновляет меню с задержкой 300мс
4. При пустом запросе - сразу обновляет меню

#### `updateMenu()`
Обновляет меню через AJAX.

**Логика:**
1. Отправляет текущий вид и поисковый запрос на сервер
2. Обновляет меню после получения ответа
3. Обрабатывает ошибки

### Работа с папками

#### `bindFolderHandlers()`
Управляет поведением папок в меню.

**Функционал:**
1. Удаляет старые обработчики
2. Добавляет новые обработчики клика по папкам
3. Сохраняет состояние папок (раскрыты/свернуты) в localStorage
4. Восстанавливает состояние папок при загрузке

### Вспомогательные методы

#### `loadMarkdownFile(mdFile)`
Загружает и отображает Markdown-файл.

**Параметры:**
- `mdFile` - путь к файлу

#### `updateUrl(mdFile)`
Обновляет URL без перезагрузки страницы.

**Параметры:**
- `mdFile` - путь к файлу для добавления в URL

#### `setActiveFile(element)`
Устанавливает активный файл в меню.

**Параметры:**
- `element` - DOM-элемент файла

#### `toggleMobileMenu(force)`
Переключает состояние мобильного меню.

**Параметры:**
- `force` - boolean, принудительно устанавливает состояние

#### `isMobileView()`
Проверяет, является ли текущий вид мобильным.

**Возвращает:**
- `true` если ширина окна ≤600px

#### `showLoading()`
Показывает индикатор загрузки.

#### `hideLoading()`
Скрывает индикатор загрузки.

#### `handlePopState()`
Обрабатывает навигацию по истории браузера.

### Инициализация

```javascript
$(document).ready(function() {
    // Проверка jQuery
    if (typeof $ === 'undefined') {
        console.error('jQuery не загружен!');
        return;
    }
    
    // Инициализация с обработкой ошибок
    try {
        new AMMDrUI();
    } catch (e) {
        console.error('Ошибка инициализации AMMDrUI:', e);
    }
});
```

## Примеры использования

### Базовое подключение
```html
<script src="ammdr.js"></script>
```

### Интеграция с PHP
Класс предназначен для работы с PHP-классом `MarkdownMenu` и ожидает определенную структуру HTML и AJAX-ответов.

## Особенности

1. **Состояние приложения**:
   - Сохраняет раскрытые папки в localStorage
   - Следит за активным файлом через URL
   - Запоминает текущий вид меню

2. **Производительность**:
   - Дебаунс для поиска (задержка 300мс)
   - Оптимизированные AJAX-запросы

3. **Адаптивность**:
   - Поддержка мобильных устройств
   - Адаптивное меню

4. **Обработка ошибок**:
   - Проверка наличия jQuery
   - Логирование ошибок в консоль
   - Индикатор загрузки

## Рекомендации

1. Используйте вместе с PHP-классом `MarkdownMenu`
2. Подключите jQuery перед ammdr.js
3. Убедитесь, что HTML-структура соответствует ожидаемой
4. Для кастомизации используйте CSS-классы из документации